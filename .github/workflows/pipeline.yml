name: RunTests

on:
  workflow_dispatch: 
  push:
    branches: 
      - sandbox
      - prod
env:
  PAT: ${{ secrets.ARM_SEC }}
  userName: fakhrihuseynov
  email: f.huseynov@etisoftware.com
  repoName: eti-onboarding
  templateName: vero
  tenantName: apb


jobs:  
  Update-Onboard-Repository:
    runs-on: ubuntu-latest
    steps:
    - name: Clone Repository
      run: |
        git config --global user.email ${{env.email}}
        git config --global user.name ${{env.userName}}
        git clone https://${{env.userName}}:${{env.PAT}}@github.com/ETI-Software-Solutions/${{env.repoName}}
        cd ${{env.repoName}}
        git remote add ${{env.repoName}} https://${{env.userName}}:$PAT@github.com/ETI-Software-Solutions/eti-gitops-templates.git
        git fetch ${{env.repoName}}
        git merge ${{env.repoName}}/main --allow-unrelated-histories
        git push origin sandbox
  
    - name: Check Replace content
      continue-on-error: true
      run: | 
        cd $GITHUB_WORKSPACE/${{env.repoName}}
        pwd
        ls -l
        find ./ -name "${{env.templateName}}*" | while read f; do mv $f $(echo $f | sed 's/${{env.templateName}}/${{env.tenantName}}/'); done
        find . -type f \( -name "*.yml" -o -name "*.yaml" -o -name "*.gitignore" -o -name "*.properties"  \) -exec perl -i -p -e 's/${{env.templateName}}/${{env.tenantName}}/g' {} +
        git add .
        git commit -m "Rename files"
        git push origin sandbox
      



    # - name: Git push
    #   env: 
    #     PAT: ${{ secrets.ARM_SEC }}
    #   run: | 
    #     git push --set-upstream $PAT@github.com/fakhrihuseynov/eti-mses-us-customer.git sandbox


# name: CloneRepository

# on:
#   push:
#     branches:
#       - sandbox

# jobs:
#   clone_repository:
#     runs-on: ubuntu-latest
    
#     steps:
#     - name: Checkout Repository
#       uses: actions/checkout@v2
      
#     - name: Clone etiflux Repository
#       run: |
#         git clone https://github.com/fakhrihuseynov/etiflux.git temp_clone
#         # git checkout -b sandbox        
#         # Push the sandbox branch to the target repository
#         # git push "https://github.com/fakhrihuseynov/eti-mses-us-customer.git" sandbox

#     - name: git push changes
#       uses: appleboy/git-push-action@v0.0.2
#       with:
#           author_email: fexrihuseynov@gmail.com
#           author_name: GiteaBot
#           branch: sandbox
#           commit: true
#           commit_message: "[skip ci] Updated changes by gitea bot"
#           remote: git@github.com:fakhrihuseynov/eti-mses-us-customer.git
#           ssh_key: ${{ secrets.ARM_SEC }}     


#     # - name: Pushes to public repository
#     #   id: push_directory
#     #   uses: cpina/github-action-push-to-another-repository@ssh-deploy-key
#     #   env:
#     #       SSH_DEPLOY_KEY: ${{ secrets.ARM_SEC }}
#     #   with:
#     #       source-directory: temp_clone/
#     #       destination-github-username: 'fakhrihuseynov'
#     #       destination-repository-name: 'eti-mses-us-customer'
#     #       user-email: fexrihuseynov@gmail.com
#     #       commit-message: pushed from $GITHUB_REF
#     #       target-branch: sandbox
